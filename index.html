<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>تطبيق بورجمان - كربلاء</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; margin: 0; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100%; z-index: 1; filter: grayscale(0.5); }
        .sidebar { transition: 0.3s; width: 0; overflow: hidden; height: 100vh; position: fixed; right: 0; top: 0; z-index: 1000; background: rgba(15, 23, 42, 0.98); border-left: 2px solid #f97316; }
        .sidebar.active { width: 85%; padding: 20px; }
        .glass-box { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* تعديل كرت المنتج لضمان ظهور الصورة كاملة */
        .product-card { background: rgba(30, 41, 59, 0.5); border-radius: 15px; padding: 12px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* هذا هو التعديل المطلوب لظهور الصورة كاملة */
        .prod-img { 
            width: 70px; 
            height: 70px; 
            border-radius: 12px; 
            object-fit: contain; /* يخلي الصورة تظهر بالكامل بدون كص */
            background-color: rgba(255, 255, 255, 0.05); /* خلفية خفيفة حتى يبرز المنتج */
            padding: 2px;
        }

        .qty-control { background: rgba(15, 23, 42, 0.8); border: 1px solid #1e293b; border-radius: 12px; display: flex; align-items: center; gap: 8px; padding: 4px; }
        .btn-qty { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; transition: 0.2s; }
        .btn-plus { background: #065f46; color: #34d399; }
        .btn-minus { background: #7f1d1d; color: #f87171; }
        
        button:disabled { background-color: #475569 !important; opacity: 0.4; cursor: not-allowed; border: none !important; }
    </style>
</head>
<body class="text-white text-right">

    <div id="loginSection" class="fixed inset-0 z-[2000] bg-slate-900 flex items-center justify-center p-6 text-center">
        <div class="glass-box p-8 rounded-3xl shadow-2xl w-full max-w-sm border-b-4 border-orange-500">
            <h1 class="text-4xl font-black text-orange-500 mb-2 tracking-tighter uppercase">BURUJMAN</h1>
            <p id="loginStatus" class="text-slate-400 text-xs mb-8">نظام التوزيع الذكي - كربلاء</p>
            <div class="space-y-4">
                <input type="text" id="userInput" class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl text-center text-white outline-none" placeholder="اسم المندوب">
                <input type="password" id="passInput" class="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl text-center text-white outline-none" placeholder="كلمة المرور">
                <button onclick="login()" id="loginBtn" class="w-full bg-orange-500 p-4 rounded-2xl font-bold text-lg text-white shadow-lg">دخول</button>
            </div>
        </div>
    </div>

    <div id="salesModal" class="hidden fixed inset-0 z-[3000] bg-[#0f172a] flex flex-col p-4">
        <div class="flex justify-between items-center mb-6 px-2">
             <button onclick="closeSalesModal()" class="text-orange-500 text-3xl font-bold">✕</button>
             <h3 id="salesStoreName" class="text-2xl font-black text-orange-500">اسم المحل</h3>
        </div>
        
        <div id="productsList" class="flex-1 overflow-y-auto px-1 space-y-4"></div>
        
        <div class="p-6 border-t border-white/10 flex justify-between items-center bg-[#0f172a]">
            <span id="totalInvoiceAmount" class="text-3xl font-black text-orange-500">0 د.ع</span>
            <span class="text-xl font-bold text-white">:الإجمالي</span>
        </div>
        <button onclick="submitOrder()" id="confirmBtn" class="w-full bg-orange-500 p-5 rounded-2xl font-black text-xl shadow-lg mb-4">تأكيد وحفظ الفاتورة</button>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-[5000] bg-black/95 flex items-center justify-center p-4">
        <div class="glass-box p-6 rounded-3xl w-full max-w-md border-t-4 border-blue-500 text-right">
            <h3 class="text-xl font-bold mb-4 text-blue-400">تقرير نهاية الزيارة</h3>
            <div id="reportInputs" class="space-y-4">
                <textarea id="vNotes" class="w-full p-4 bg-slate-800 rounded-xl text-sm h-24 text-white outline-none border border-slate-700" placeholder="اكتب ملاحظات الزيارة..."></textarea>
                <div class="flex items-center justify-between bg-slate-800 p-4 rounded-2xl border border-slate-700">
                    <button onclick="changeVisitDays(-1)" class="btn-qty btn-minus">-</button>
                    <div class="text-center">
                        <span id="nextDaysVal" class="text-2xl font-black">4</span>
                        <p id="nextDateText" class="text-[10px] text-orange-400">موعد القادم</p>
                    </div>
                    <button onclick="changeVisitDays(1)" class="btn-qty btn-plus">+</button>
                </div>
            </div>
            <button onclick="submitFinalReport()" id="reportSubmitBtn" class="w-full mt-6 bg-blue-600 p-4 rounded-2xl font-bold shadow-lg">حفظ التقرير</button>
        </div>
    </div>

    <div id="mainApp" class="hidden h-screen w-full relative">
        <div id="sidebar" class="sidebar shadow-2xl">
            <div class="flex justify-between items-center mb-8 border-b border-orange-500/20 pb-4">
                <h2 class="text-xl font-bold text-orange-500">الإدارة</h2>
                <button onclick="toggleSidebar()" class="text-3xl">✕</button>
            </div>
            <div class="space-y-4 text-right">
                 <p id="activeUser" class="font-bold text-lg text-white">-</p>
                 <p id="activeRegion" class="text-xs text-orange-400"></p>
                 <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="bg-slate-800 p-3 rounded-xl text-center"><p id="visitCount" class="text-xl font-black">0</p><small class="text-[10px]">زيارات</small></div>
                    <div class="bg-slate-800 p-3 rounded-xl text-center"><p id="salesTotal" class="text-xl font-black text-orange-500">0k</p><small class="text-[10px]">مبيعات</small></div>
                </div>
                <button onclick="location.reload()" class="w-full p-4 mt-10 bg-red-600/20 text-red-500 rounded-2xl font-bold">تسجيل خروج</button>
            </div>
        </div>
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 z-[100] bg-orange-500 p-4 rounded-2xl shadow-2xl text-white">☰</button>
        <div id="map"></div>
    </div>

    <div id="visitBar" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[4000] w-[90%] max-w-sm bg-orange-600 p-4 rounded-3xl shadow-2xl flex justify-between items-center">
        <div class="text-right">
            <p id="timerStoreName" class="text-[10px] font-bold text-white/80"></p>
            <p id="visitTimer" class="text-2xl font-black text-white">00:00</p>
        </div>
        <button onclick="openReport()" class="bg-white text-orange-600 px-6 py-2 rounded-2xl font-black shadow-lg">إنهاء الزيارة</button>
    </div>

    <script>
        let scriptURL = "https://script.google.com/macros/s/AKfycbyJcHq_3Sn2aSoEzYjlNiL4d1Q3XLOcEdlEjqQ44txCFCgGvX9Rf53_PYVTf6t8R4Ct/exec"; 
        let map, currentUser, allProducts = [], markers = [], selectedItems = {};
        let timerInterval, seconds = 0, activeStoreForVisit = null, nextVisitDays = 4;

        function login() {
            let u = document.getElementById('userInput').value.trim();
            let p = document.getElementById('passInput').value.trim();
            if (!u || !p) return;
            const btn = document.getElementById('loginBtn');
            btn.innerText = "جاري التحقق..."; btn.disabled = true;
            callScript(`action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`, "handleLogin");
        }

        function handleLogin(data) {
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('loginBtn').innerText = "دخول";
            if (data.status === "success") {
                currentUser = data;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('activeUser').innerText = data.name;
                document.getElementById('activeRegion').innerText = "المنطقة: " + data.region;
                initMap(); loadProducts(); updateStats();
            } else { document.getElementById('loginStatus').innerText = "اسم المستخدم أو كلمة المرور غير صحيحة!"; }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.6160, 44.0249], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            loadStores();
        }

        function loadStores() {
            callScript(`action=getStores&region=${encodeURIComponent(currentUser.region)}`, "handleStores");
        }

        function handleStores(stores) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            stores.forEach(p => {
                let isThisActive = activeStoreForVisit === p.name;
                let finalColor = (activeStoreForVisit && !isThisActive) ? "#475569" : getStatusColor(p.lastVisit);
                
                let m = L.circleMarker([parseFloat(p.lat), parseFloat(p.lng)], { 
                    radius: 12, fillColor: finalColor, color: isThisActive ? "#f97316" : "#fff", weight: isThisActive ? 5 : 2, fillOpacity: 0.9 
                }).addTo(map);

                let vBtn = activeStoreForVisit ? 'disabled' : '';
                let sBtn = (!activeStoreForVisit || !isThisActive) ? 'disabled' : '';

                m.bindPopup(`
                    <div class="text-right p-2 min-w-[220px] font-bold">
                        <b class="text-lg text-slate-900">${p.name}</b><hr class="my-2">
                        <div class="flex gap-2">
                            <button onclick="handleVisitBtn('${p.name}')" ${vBtn} class="flex-1 bg-green-600 text-white p-3 rounded-xl">بدء زيارة</button>
                            <button onclick="openSalesModal('${p.name}')" ${sBtn} class="flex-1 bg-orange-500 text-white p-3 rounded-xl">مبيع</button>
                        </div>
                    </div>
                `);
                markers.push(m);
            });
        }

        function handleVisitBtn(storeName) {
            if (activeStoreForVisit) return;
            activeStoreForVisit = storeName; seconds = 0;
            document.getElementById('timerStoreName').innerText = "زيارة لأسواق: " + storeName;
            document.getElementById('visitBar').classList.remove('hidden');
            timerInterval = setInterval(() => {
                seconds++; let m = Math.floor(seconds / 60); let s = seconds % 60;
                document.getElementById('visitTimer').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }, 1000);
            map.closePopup(); loadStores(); 
        }

        function openSalesModal(storeName) {
            if (!activeStoreForVisit || activeStoreForVisit !== storeName) return;
            document.getElementById('salesStoreName').innerText = storeName;
            const list = document.getElementById('productsList');
            
            list.innerHTML = allProducts.map(prod => `
                <div class="product-card flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="${prod.img}" class="prod-img" onerror="this.src='https://placehold.co/100?text=Img'">
                        <div class="text-right">
                            <p class="font-bold text-white text-sm leading-tight">${prod.name}</p>
                            <p class="text-orange-400 font-black text-xs">${prod.price.toLocaleString()} د.ع</p>
                        </div>
                    </div>
                    <div class="qty-control">
                        <button onclick="changeQty('${prod.name}', 1)" class="btn-qty btn-plus">+</button>
                        <span id="qty-${prod.name}" class="text-xl font-black text-orange-500 min-w-[25px] text-center">${selectedItems[prod.name] || 0}</span>
                        <button onclick="changeQty('${prod.name}', -1)" class="btn-qty btn-minus">-</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('salesModal').classList.remove('hidden');
            calcTotal();
        }

        function changeQty(prodName, val) {
            selectedItems[prodName] = (selectedItems[prodName] || 0) + val;
            if (selectedItems[prodName] < 0) selectedItems[prodName] = 0;
            document.getElementById(`qty-${prodName}`).innerText = selectedItems[prodName];
            calcTotal();
        }

        function calcTotal() {
            let total = 0;
            allProducts.forEach(p => total += (selectedItems[p.name] || 0) * p.price);
            document.getElementById('totalInvoiceAmount').innerText = total.toLocaleString() + " د.ع";
        }

        function submitOrder() {
            let items = [];
            allProducts.forEach(p => { if (selectedItems[p.name] > 0) items.push({ name: p.name, price: p.price, qty: selectedItems[p.name] }); });
            if (items.length === 0) return;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true; btn.innerText = "جاري الحفظ...";
            callScript(`action=submitOrder&user=${encodeURIComponent(currentUser.name)}&store=${encodeURIComponent(activeStoreForVisit)}&duration=${Math.round(seconds/60)}&items=${encodeURIComponent(JSON.stringify(items))}`, "afterSave");
        }

        function afterSave() {
            document.getElementById('confirmBtn').disabled = false;
            document.getElementById('confirmBtn').innerText = "تأكيد وحفظ الفاتورة";
            document.getElementById('salesModal').classList.add('hidden');
            updateStats();
        }

        function openReport() {
            updateVisitDateText();
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function changeVisitDays(val) {
            nextVisitDays += val; if(nextVisitDays < 1) nextVisitDays = 1; updateVisitDateText();
        }

        function updateVisitDateText() {
            let d = new Date(); d.setDate(d.getDate() + nextVisitDays);
            document.getElementById('nextDaysVal').innerText = nextVisitDays;
            document.getElementById('nextDateText').innerText = d.toLocaleDateString('ar-IQ', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        function submitFinalReport() {
            const btn = document.getElementById('reportSubmitBtn');
            let notes = document.getElementById('vNotes').value;
            let d = new Date(); d.setDate(d.getDate() + nextVisitDays);
            btn.innerText = "جاري الحفظ..."; btn.disabled = true;
            callScript(`action=submitOrder&store=${encodeURIComponent(activeStoreForVisit)}&user=${encodeURIComponent(currentUser.name)}&duration=${Math.round(seconds/60)}&status=تقرير&notes=${encodeURIComponent(notes)}&nextVisit=${d.toISOString().split('T')[0]}&items=[]`, "afterReportSave");
        }

        function afterReportSave() {
            clearInterval(timerInterval);
            document.getElementById('visitBar').classList.add('hidden');
            document.getElementById('reportModal').classList.add('hidden');
            activeStoreForVisit = null; selectedItems = {};
            loadStores(); updateStats();
        }

        function callScript(p, c) {
            let s = document.createElement('script');
            s.src = `${scriptURL}?${p}&callback=${c}&_=${new Date().getTime()}`;
            document.body.appendChild(s);
        }

        function updateStats() { callScript(`action=getStats&user=${encodeURIComponent(currentUser.name)}`, "displayStats"); }
        function displayStats(d) {
            document.getElementById('visitCount').innerText = d.visits || 0;
            document.getElementById('salesTotal').innerText = (parseFloat(d.sales) / 1000).toFixed(0) + "k";
        }
        function getStatusColor(date) {
            if(!date || date === "No Visit") return "#ef4444";
            let diff = Math.ceil(Math.abs(new Date() - new Date(date)) / (1000 * 60 * 60 * 24));
            return diff <= 2 ? "#22c55e" : (diff <= 7 ? "#eab308" : "#ef4444");
        }
        function closeSalesModal() { document.getElementById('salesModal').classList.add('hidden'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function loadProducts() { callScript("action=getProducts", "setProducts"); }
        function setProducts(d) { allProducts = d; }
    </script>
</body>
</html>